<div class="admin-dashboard" [style.background]="'var(--background)'">
  @if (loading().analytics && loading().users && loading().materials) {
    <div class="dashboard-loading">
      <div class="spinner"></div>
      <p>{{ t('loading') }}</p>
    </div>
  } @else if (error()) {
    <div class="dashboard-error">
      <div class="error-message">{{ error() }}</div>
      <button (click)="refetch()" class="retry-button">
        <fa-icon [icon]="faSync"></fa-icon>
        {{ t('retry') || 'Retry' }}
      </button>
    </div>
  } @else {
    <div class="dashboard-container">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="header-content">
          <div>
            <h1 class="dashboard-title">
              <fa-icon [icon]="faChartLine" class="title-icon"></fa-icon>
              {{ t('Admin Dashboard') || 'Admin Dashboard' }}
            </h1>
            <p class="dashboard-date">{{ getFormattedDate() }}</p>
          </div>
          <button (click)="refetch()" class="refresh-btn" [class.loading]="loading().analytics">
            <fa-icon [icon]="faSync" [class.spinning]="loading().analytics"></fa-icon>
          </button>
        </div>
      </div>

      <!-- Stat Cards -->
      <div class="stat-cards-grid">
        <div class="stat-card stat-card-orders">
          <div class="stat-card-background"></div>
          <div class="stat-card-content">
            <div class="stat-card-info">
              <p class="stat-card-label">{{ t('Total Orders') || 'Total Orders' }}</p>
              <p class="stat-card-value">{{ convertNumber(data().totalOrders.toLocaleString()) || '0' }}</p>
            </div>
            <div class="stat-card-icon orders-icon">
              <fa-icon [icon]="faShoppingCart"></fa-icon>
            </div>
          </div>
          <div class="stat-card-trend">
            <fa-icon [icon]="faArrowUp" class="trend-icon up"></fa-icon>
            <span class="trend-value">+8%</span>
            <span class="trend-label">{{ t('vsLastPeriod') || 'vs last period' }}</span>
          </div>
        </div>

        <div class="stat-card stat-card-users">
          <div class="stat-card-background"></div>
          <div class="stat-card-content">
            <div class="stat-card-info">
              <p class="stat-card-label">{{ t('activeUsers') || 'Active Users' }}</p>
              <p class="stat-card-value">{{ convertNumber(data().topUsers.length) || '0' }}</p>
            </div>
            <div class="stat-card-icon users-icon">
              <fa-icon [icon]="faUsers"></fa-icon>
            </div>
          </div>
          <div class="stat-card-trend">
            <fa-icon [icon]="faMinus" class="trend-icon steady"></fa-icon>
            <span class="trend-value">{{ t('Steady') || 'Steady' }}</span>
            <span class="trend-label">{{ t('vs last period') || 'vs last period' }}</span>
          </div>
        </div>

        <div class="stat-card stat-card-materials">
          <div class="stat-card-background"></div>
          <div class="stat-card-content">
            <div class="stat-card-info">
              <p class="stat-card-label">{{ t('Materials Tracked') || 'Materials Tracked' }}</p>
              <p class="stat-card-value">{{ convertNumber(data().topMaterials.length) || '0' }}</p>
            </div>
            <div class="stat-card-icon materials-icon">
              <fa-icon [icon]="faRecycle"></fa-icon>
            </div>
          </div>
          <div class="stat-card-trend">
            <fa-icon [icon]="faArrowUp" class="trend-icon up"></fa-icon>
            <span class="trend-value">+5%</span>
            <span class="trend-label">{{ t('vs last period') || 'vs last period' }}</span>
          </div>
        </div>
      </div>

      <!-- Charts Grid - Three Equal Charts -->
      <div class="charts-grid-equal">
        <!-- Order Status Chart -->
        @if (orderStatusChartData.labels && orderStatusChartData.labels.length > 0) {
          <div class="chart-container-equal">
            <div class="chart-card-equal">
              <div class="chart-header order-status-header">
                <h3 class="chart-title">{{ t('Order Status') || 'Order Status' }}</h3>
                <span class="overview-text">Overview</span>
              </div>
              <div class="order-status-content">
                <div class="order-status-chart-wrapper">
                  <canvas baseChart
                    [data]="orderStatusChartData"
                    [type]="'doughnut'"
                    [options]="orderStatusChartOptions"
                    class="order-status-chart">
                  </canvas>
                </div>
                <div class="order-status-legend">
                  @for (status of orderStatusChartData.labels; track status; let i = $index) {
                    <div class="legend-item">
                      <div class="legend-dot" [style.background-color]="getStatusColor(status)"></div>
                      <span class="legend-label">{{ status }}</span>
                      <span class="legend-count">{{ getOrderStatusCount(status) }}</span>
                    </div>
                  }
                </div>
                <div class="order-status-summary">
                  <span class="summary-text">
                    Most Common: <strong>{{ getMostCommonStatus() }}</strong>
                  </span>
                  <span class="summary-total">Total: {{ getTotalOrders() }}</span>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Top Users Card (Like Next.js) -->
        <div class="chart-container-equal">
          <div class="chart-card-equal top-users-card-equal">
            <div class="chart-header">
              <h3 class="chart-title">{{ t('Top Users') || 'Top Users' }}</h3>
            </div>
            @if (loading().users) {
              <div class="top-users-loading">
                <div class="spinner-small"></div>
                <p>Loading users...</p>
              </div>
            } @else if (getTopUsers().length > 0) {
              <div class="top-users-list-card">
                @for (user of getTopUsers(); track user.id || user._id || user.userId || $index; let i = $index) {
                  <div class="top-user-card-item" [style.background]="getRankBackgroundGradient(i)">
                    <div class="top-user-card-rank">
                      <fa-icon [icon]="getRankIcon(i)" [style.color]="getRankColor(i)"></fa-icon>
                      <span class="rank-number-card">#{{ i + 1 }}</span>
                    </div>
                    <div class="top-user-card-avatar">
                      @if (getUserAvatar(user)) {
                        <img [src]="getUserAvatar(user)" [alt]="user.name || user.fullName" class="avatar-image-card" />
                      } @else {
                        <div class="avatar-initials-card" [style.background-color]="getRankColor(i) + '20'">
                          {{ getUserInitials(user) }}
                        </div>
                      }
                    </div>
                    <div class="top-user-card-info">
                      <div class="top-user-card-name">{{ user.name || user.fullName || 'Unknown' }}</div>
                      <div class="top-user-card-points">
                        {{ convertNumber((user.points || user.totalPoints || 0).toLocaleString()) }} {{ t('points') || 'Points' }}
                      </div>
                      <div class="top-user-card-progress">
                        <div class="progress-bar-card">
                          <div 
                            class="progress-fill-card" 
                            [style.width.%]="getProgressPercentage(user, getMaxPoints())"
                            [style.background-color]="getRankColor(i)">
                          </div>
                        </div>
                      </div>
                    </div>
                    @if (i < 3) {
                      <div class="top-user-card-badge" [style.background-color]="getRankBadgeColor(i)">
                        {{ i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰' }}
                      </div>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="top-users-empty">
                <div class="empty-icon">ðŸ‘¥</div>
                <p>No users found</p>
              </div>
            }
          </div>
        </div>

        <!-- User Growth Chart -->
        @if (userGrowthChartData.labels && userGrowthChartData.labels.length > 0) {
          <div class="chart-container-equal">
            <div class="chart-card-equal">
              <div class="chart-header">
                    <h3 class="chart-title">{{ t('User Growth') || 'User Growth' }}</h3>
              </div>
              <div class="chart-wrapper-equal">
                <canvas baseChart
                  [data]="userGrowthChartData"
                  [type]="'line'"
                  [options]="chartOptions">
                </canvas>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Top Users List -->
      @if (getTopUsers().length > 0) {
        <div class="top-users-list-section">
          <div class="chart-container full-width">
            <div class="chart-card">
              <div class="chart-header">
                <div class="chart-title-wrapper">
                  <fa-icon [icon]="faTrophy" class="chart-title-icon"></fa-icon>
                  <h3 class="chart-title">{{ t('Top Recyclers') || 'Top Recyclers' }}</h3>
                </div>
              </div>
              <div class="top-users-list">
                @for (user of getTopUsers().slice(0, 3); track user.id || user._id; let i = $index) {
                  <div class="top-user-item" [style.background-color]="getRankBackgroundColor(i)">
                    <div class="top-user-rank-badge">
                      <fa-icon [icon]="getRankIcon(i)" [style.color]="getRankColor(i)"></fa-icon>
                      <span class="rank-number-badge">#{{ i + 1 }}</span>
                    </div>
                    <div class="top-user-avatar">
                      @if (getUserAvatar(user)) {
                        <img [src]="getUserAvatar(user)" [alt]="user.name || user.fullName" class="avatar-image" />
                      } @else {
                        <div class="avatar-initials" [style.background-color]="getRankColor(i) + '20'">
                          {{ getUserInitials(user) }}
                        </div>
                      }
                    </div>
                    <div class="top-user-info">
                      <div class="top-user-name">{{ user.name || user.fullName || 'Unknown' }}</div>
                      <div class="top-user-points">
{{ convertNumber(((user.points || user.totalPoints || 0)).toLocaleString()) }} Points
                      </div>
                      <div class="top-user-progress">
                        <div class="progress-bar">
                          <div 
                            class="progress-fill" 
                            [style.width.%]="getProgressPercentage(user, getMaxPoints())"
                            [style.background-color]="getRankColor(i)">
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="top-user-medal">
                      <fa-icon [icon]="getRankIcon(i)" [style.color]="getRankColor(i)"></fa-icon>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      }

      <!-- Materials and Cities Charts - Side by Side -->
      <div class="charts-row">
        <!-- Materials Chart -->
        @if (materialsChartData.labels && materialsChartData.labels.length > 0) {
          <div class="chart-container">
            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">{{ t('Top Recycled Materials') || 'Top Recycled Materials' }}</h3>
              </div>
              <div class="chart-wrapper">
                <canvas baseChart
                  [data]="materialsChartData"
                  [type]="'bar'"
                  [options]="chartOptions">
                </canvas>
              </div>
            </div>
          </div>
        }

        <!-- Cities Chart -->
        @if (citiesChartData && citiesChartData.labels && citiesChartData.labels.length > 0) {
          <div class="chart-container">
            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">{{ t('Top Cities') || 'Top Cities' }}</h3>
              </div>
              <div class="chart-wrapper">
                <canvas baseChart
                  [data]="citiesChartData"
                  [type]="'bar'"
                  [options]="chartOptions">
                </canvas>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Weekly Orders Chart -->
      @if (weeklyOrdersChartData.labels && weeklyOrdersChartData.labels.length > 0) {
        <div class="chart-container full-width">
          <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">{{ t('Weekly Orders Distribution') || 'Weekly Orders Distribution' }}</h3>
            </div>
            <div class="chart-wrapper">
              <canvas baseChart
                [data]="weeklyOrdersChartData"
                [type]="'bar'"
                [options]="chartOptions">
              </canvas>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>
