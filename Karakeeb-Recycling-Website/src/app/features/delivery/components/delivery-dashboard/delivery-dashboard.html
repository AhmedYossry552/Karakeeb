<!-- Main Dashboard Page -->
<div class="delivery-dashboard-page">
  <!-- Animated Hero Header -->
  <div class="dashboard-hero">
    <div class="hero-background-animated"></div>
    <div class="hero-content-wrapper">
      <div class="hero-main-content">
        <!-- Left: Icon + Title -->
        <div class="hero-title-section">
          <div class="hero-icon-box">
            <div class="icon-glow"></div>
            <fa-icon [icon]="faTruck" class="hero-icon"></fa-icon>
          </div>
          <div class="hero-text">
            <h1 class="hero-title">{{ translation.t('Delivery Dashboard') || 'Delivery Dashboard' }}</h1>
            <p class="hero-subtitle">{{ translation.t('Manage your assigned delivery orders') || 'Manage your assigned delivery orders' }}</p>
          </div>
        </div>

        <!-- Right: Stats + Language + Avatar -->
        <div class="hero-actions">
          <!-- Orders Count Badge -->
          <div class="orders-badge">
            <div class="badge-icon-wrapper">
              <fa-icon [icon]="faBox" class="badge-icon"></fa-icon>
            </div>
            <div class="badge-content">
              <span class="badge-number">{{ orders().length }}</span>
              <span class="badge-label">{{ translation.t('Orders') || 'Orders' }}</span>
            </div>
          </div>

          <!-- Language Toggle - Desktop -->
          <div class="language-toggle-desktop">
            <span class="lang-label" [ngClass]="{'active': getCurrentLanguage() === 'en'}">EN</span>
            <button
              (click)="toggleLanguage()"
              class="lang-switch"
              [class.active]="getCurrentLanguage() === 'ar'"
              title="Toggle Language"
            >
              <div class="lang-switch-thumb"></div>
            </button>
            <span class="lang-label" [ngClass]="{'active': getCurrentLanguage() === 'ar'}">AR</span>
          </div>

          <!-- User Avatar Dropdown -->
          <div #dropdownRef class="user-avatar-dropdown">
            <button (click)="togglePopup()" class="avatar-button">
              <div class="avatar-container">
                <img
                  *ngIf="getUserImage() && !imageError()"
                  [src]="getUserImage()"
                  alt="User Avatar"
                  class="avatar-img"
                  (error)="onImageError()"
                />
                <div
                  *ngIf="!getUserImage() || imageError()"
                  class="avatar-initials"
                >
                  {{ getInitials(user()?.name || 'U') }}
                </div>
                <div class="avatar-status"></div>
              </div>
            </button>

            <!-- Dropdown Menu - Next.js Style -->
            <div *ngIf="showPopup()" class="dropdown-menu">
              <!-- User Info Section -->
              <div class="dropdown-header">
                <div class="dropdown-avatar-wrapper">
                  <img
                    *ngIf="getUserImage() && !imageError()"
                    [src]="getUserImage()"
                    alt="User"
                    class="dropdown-avatar-img"
                    (error)="onImageError()"
                  />
                  <div
                    *ngIf="!getUserImage() || imageError()"
                    class="dropdown-avatar-initials"
                  >
                    {{ getInitials(user()?.name || 'U') }}
                  </div>
                </div>
                <div class="dropdown-user-info">
                  <p class="dropdown-name">{{ user()?.name || 'User' }}</p>
                  <p class="dropdown-email">{{ user()?.email || 'user@example.com' }}</p>
                  <span *ngIf="user()?.role" class="dropdown-role-badge">
                    {{ user()?.role || 'Delivery' }}
                  </span>
                </div>
              </div>

              <!-- Menu Items -->
              <div class="dropdown-items">
                <button (click)="goToProfile()" class="dropdown-item">
                  <fa-icon [icon]="faUser" class="dropdown-item-icon"></fa-icon>
                  <span class="dropdown-item-text">{{ translation.t('My Profile') || 'My Profile' }}</span>
                </button>

                <button (click)="goToSettings()" class="dropdown-item">
                  <fa-icon [icon]="faCog" class="dropdown-item-icon"></fa-icon>
                  <span class="dropdown-item-text">{{ translation.t('Settings') || 'Settings' }}</span>
                </button>

                <div class="dropdown-divider"></div>

                <button (click)="goToSignOut()" class="dropdown-item danger">
                  <fa-icon [icon]="faSignOutAlt" class="dropdown-item-icon"></fa-icon>
                  <span class="dropdown-item-text">{{ translation.t('Sign Out') || 'Sign Out' }}</span>
                </button>

                <!-- Language Toggle - Mobile Only -->
                <div class="dropdown-divider mobile-only"></div>
                <div class="dropdown-language mobile-only">
                  <span class="lang-label" [ngClass]="{'active': getCurrentLanguage() === 'en'}">EN</span>
                  <button
                    (click)="toggleLanguage()"
                    class="lang-switch"
                    [class.active]="getCurrentLanguage() === 'ar'"
                  >
                    <div class="lang-switch-thumb"></div>
                  </button>
                  <span class="lang-label" [ngClass]="{'active': getCurrentLanguage() === 'ar'}">AR</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="dashboard-content">
    <!-- Search and Refresh Section -->
    <div class="search-refresh-section">
      <div class="search-container">
        <div class="search-wrapper">
          <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
          <input
            type="text"
            [value]="searchTerm()"
            (input)="searchTerm.set($any($event.target).value)"
            [placeholder]="translation.t('Search by customer name, email, or status...') || 'Search by customer name, email, or status...'"
            class="search-input"
          />
        </div>
        <button
          (click)="loadOrders()"
          [disabled]="isFetching()"
          class="refresh-button"
        >
          <fa-icon [icon]="faRotateRight" [class.spinning]="isFetching()" class="refresh-icon"></fa-icon>
          <span>{{ isFetching() ? (translation.t('Refreshing...') || 'Refreshing...') : (translation.t('Refresh') || 'Refresh') }}</span>
        </button>
      </div>
      <!-- Search Results Count -->
      <div *ngIf="searchTerm()" class="search-results">
        <span class="results-text">
          <strong>{{ getFilteredOrders().length }}</strong>
          {{ getFilteredOrders().length === 1 ? (translation.t('Order') || 'Order') : (translation.t('Orders') || 'Orders') }} found
          <span *ngIf="getFilteredOrders().length !== orders().length" class="results-total">
            ({{ translation.t('of') || 'of' }} {{ orders().length }} {{ translation.t('total') || 'total' }})
          </span>
        </span>
      </div>
    </div>

    <!-- Orders Table Card -->
    <div class="orders-card">
      <!-- Loading State -->
      <div *ngIf="loading()" class="loading-state">
        <div class="loading-spinner-large">
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
          <div class="spinner-ring"></div>
        </div>
        <p class="loading-text">{{ translation.t('Loading Orders...') || 'Loading Orders...' }}</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!loading() && getFilteredOrders().length === 0" class="empty-state">
        <div class="empty-icon-container">
          <fa-icon [icon]="faTruck" class="empty-icon"></fa-icon>
        </div>
        <h3 class="empty-title">{{ translation.t('No Assigned Orders') || 'No Assigned Orders' }}</h3>
        <p class="empty-description">{{ translation.t('No Orders Assigned Yet') || 'No Orders Assigned Yet' }}</p>
      </div>

      <!-- Orders Table -->
      <div *ngIf="!loading() && getFilteredOrders().length > 0" class="table-container">
        <table class="orders-table">
          <thead class="table-header">
            <tr>
              <th class="table-header-cell">{{ translation.t('Customer') || 'Customer' }}</th>
              <th class="table-header-cell">{{ translation.t('Order Date') || 'Order Date' }}</th>
              <th class="table-header-cell">{{ translation.t('Order Details') || 'Order Details' }}</th>
              <th class="table-header-cell">{{ translation.t('Status') || 'Status' }}</th>
              <th class="table-header-cell">{{ translation.t('Actions') || 'Actions' }}</th>
            </tr>
          </thead>
          <tbody class="table-body">
            <tr *ngFor="let order of getFilteredOrders(); let last = last" class="table-row" [class.last-row]="last">
              <!-- Customer -->
              <td class="table-cell customer-cell">
                <div *ngIf="order.user; else noUser" class="customer-info">
                  <div class="customer-avatar-wrapper">
                    <img
                      *ngIf="order.user?.image || order.user?.imageUrl"
                      [src]="order.user.image || order.user.imageUrl"
                      [alt]="order.user.userName || order.user.name"
                      class="customer-avatar"
                      (error)="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='flex'"
                    />
                    <div
                      *ngIf="!order.user?.image && !order.user?.imageUrl"
                      class="customer-avatar-placeholder"
                    >
                      {{ getInitials(order.user?.userName || order.user?.name || 'U') }}
                    </div>
                    <div class="customer-status-dot"></div>
                  </div>
                  <div class="customer-details">
                    <p class="customer-name">{{ order.user?.userName || order.user?.name }}</p>
                    <p class="customer-role">{{ order.user?.role === 'buyer' ? (translation.t('Buyer') || 'Buyer') : (translation.t('Customer') || 'Customer') }}</p>
                  </div>
                </div>
                <ng-template #noUser>
                  <span class="no-user-text">{{ translation.t('N/A') || 'N/A' }}</span>
                </ng-template>
              </td>

              <!-- Order Date -->
              <td class="table-cell date-cell">
                <p class="date-text">{{ formatDate(order.createdAt) }}</p>
                <p class="time-text">
                  <fa-icon [icon]="faClock" class="time-icon"></fa-icon>
                  {{ formatTime(order.createdAt) }}
                </p>
              </td>

              <!-- Order Details -->
              <td class="table-cell details-cell">
                <button
                  type="button"
                  (click)="handleViewOrderDetails(order)"
                  class="details-button"
                >
                  <fa-icon [icon]="faFileInvoice" class="button-icon"></fa-icon>
                    {{ translation.t('View Details') || 'View Details' }}
                </button>
              </td>

              <!-- Status -->
              <td class="table-cell status-cell">
                <span class="status-badge" [ngClass]="getStatusBadgeClass(order.status)">
                  {{ getStatusBadge(order.status) }}
                </span>
              </td>

              <!-- Actions -->
              <td class="table-cell actions-cell">
                <ng-container *ngIf="order.status === 'assigntocourier' && order.user; else deliveredBadge">
                  <button
                    type="button"
                    (click)="handleCompleteOrder(order)"
                    class="action-button"
                  >
                    <fa-icon [icon]="faCheckCircle" class="action-icon"></fa-icon>
                    {{ getActionButtonText(order) }}
                  </button>
                </ng-container>
                <ng-template #deliveredBadge>
                  <div *ngIf="order.status === 'completed' && order.deliveryProof" class="delivered-badge">
                    <fa-icon [icon]="faCheckCircle" class="delivered-icon"></fa-icon>
                    <span>{{ translation.t('Delivered') || 'Delivered' }}</span>
                  </div>
                </ng-template>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div *ngIf="isDetailsModalOpen()" class="modal-overlay" (click)="closeDetailsModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="modal-header-content">
        <div class="modal-icon-box">
          <fa-icon [icon]="faFileInvoice" class="modal-icon"></fa-icon>
        </div>
        <div class="modal-title-group">
          <h2 class="modal-title">{{ translation.t('Order Details') || 'Order Details' }}</h2>
          <p class="modal-subtitle">{{ translation.t('Complete order information') || 'Complete order information' }}</p>
        </div>
      </div>
      <button (click)="closeDetailsModal()" class="modal-close">
        <fa-icon [icon]="faX" class="close-icon"></fa-icon>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="modal-body" *ngIf="selectedOrderDetails()">
      <!-- Customer Information -->
      <div class="modal-section">
        <div class="section-header">
          <div class="section-icon customer-icon">
            <fa-icon [icon]="faUser" class="section-icon-svg"></fa-icon>
          </div>
          <h3 class="section-title">{{ translation.t('Customer Information') || 'Customer Information' }}</h3>
        </div>

        <div *ngIf="selectedOrderDetails()?.user; else noCustomer" class="customer-card">
          <div class="customer-card-content">
            <div class="customer-card-avatar">
              <img
                *ngIf="selectedOrderDetails()?.user?.imageUrl || selectedOrderDetails()?.user?.image"
                [src]="selectedOrderDetails()?.user?.imageUrl || selectedOrderDetails()?.user?.image"
                alt="Customer"
                class="card-avatar-img"
                (error)="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='flex'"
              />
              <div
                *ngIf="!selectedOrderDetails()?.user?.imageUrl && !selectedOrderDetails()?.user?.image"
                class="card-avatar-placeholder"
              >
                {{ getInitials(selectedOrderDetails()?.user?.userName || selectedOrderDetails()?.user?.name || 'U') }}
              </div>
              <div class="card-avatar-status"></div>
            </div>

            <div class="customer-card-info">
              <div class="info-grid">
                <div class="info-item">
                  <p class="info-label">{{ translation.t('Full Name') || 'Full Name' }}</p>
                  <p class="info-value">{{ selectedOrderDetails()?.user?.userName || selectedOrderDetails()?.user?.name || 'N/A' }}</p>
                </div>
                <div class="info-item">
                  <p class="info-label">{{ translation.t('User Role') || 'User Role' }}</p>
                  <span class="role-badge" [ngClass]="{
                    'role-buyer': selectedOrderDetails()?.user?.role === 'buyer',
                    'role-customer': selectedOrderDetails()?.user?.role === 'customer'
                  }">
                    {{ selectedOrderDetails()?.user?.role === 'buyer' ? (translation.t('Buyer') || 'Buyer') : (translation.t('Customer') || 'Customer') }}
                  </span>
                </div>
                <div class="info-item">
                  <p class="info-label">{{ translation.t('Email') || 'Email' }}</p>
                  <p class="info-value">{{ selectedOrderDetails()?.user?.email || 'N/A' }}</p>
                </div>
                <div class="info-item">
                  <p class="info-label">{{ translation.t('Phone') || 'Phone' }}</p>
                  <p class="info-value">{{ selectedOrderDetails()?.user?.phoneNumber || selectedOrderDetails()?.user?.phone || 'N/A' }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noCustomer>
          <div class="no-data-card">
            <fa-icon [icon]="faUser" class="no-data-icon"></fa-icon>
            <p class="no-data-title">{{ translation.t('Customer information not available') || 'Customer information not available' }}</p>
            <p class="no-data-text">{{ translation.t('This is a backend issue - the endpoint needs to populate user field') || 'This is a backend issue - the endpoint needs to populate user field' }}</p>
          </div>
        </ng-template>
      </div>

      <!-- Delivery Address -->
      <div class="modal-section">
        <div class="section-header">
          <div class="section-icon address-icon">
            <fa-icon [icon]="faMapMarkerAlt" class="section-icon-svg"></fa-icon>
          </div>
              <h3 class="section-title">{{ translation.t('Delivery Address') || 'Delivery Address' }}</h3>
        </div>

        <div *ngIf="selectedOrderDetails()?.address" class="address-card">
          <div class="address-grid">
            <div class="address-item">
              <p class="address-label">{{ translation.t('City') || 'City' }}</p>
              <p class="address-value">{{ selectedOrderDetails()?.address?.city || 'N/A' }}</p>
            </div>
            <div class="address-item">
              <p class="address-label">{{ translation.t('Area') || 'Area' }}</p>
              <p class="address-value">{{ selectedOrderDetails()?.address?.area || 'N/A' }}</p>
            </div>
            <div class="address-item">
              <p class="address-label">{{ translation.t('Street') || 'Street' }}</p>
              <p class="address-value">{{ selectedOrderDetails()?.address?.street || 'N/A' }}</p>
            </div>
            <div class="address-item">
              <p class="address-label">{{ translation.t('Building') || 'Building' }}</p>
              <p class="address-value">{{ selectedOrderDetails()?.address?.building || 'N/A' }}</p>
            </div>
            <div class="address-item">
              <p class="address-label">{{ translation.t('Floor') || 'Floor' }}</p>
              <p class="address-value">{{ selectedOrderDetails()?.address?.floor || 'N/A' }}</p>
            </div>
            <div class="address-item">
              <p class="address-label">{{ translation.t('Apartment') || 'Apartment' }}</p>
              <p class="address-value">{{ selectedOrderDetails()?.address?.apartment || 'N/A' }}</p>
            </div>
          </div>
          <div *ngIf="selectedOrderDetails()?.address?.landmark" class="address-landmark">
            <fa-icon [icon]="faMapMarkerAlt" class="landmark-icon"></fa-icon>
            <div>
              <p class="landmark-label">{{ translation.t('Landmark') || 'Landmark' }}</p>
              <p class="landmark-value">{{ selectedOrderDetails()?.address?.landmark }}</p>
            </div>
          </div>
        </div>

        <div *ngIf="!selectedOrderDetails()?.address" class="no-data-card">
          <fa-icon [icon]="faMapMarkerAlt" class="no-data-icon"></fa-icon>
          <p class="no-data-title">{{ translation.t('Delivery address not available') || 'Delivery address not available' }}</p>
          <p class="no-data-text">{{ translation.t('This is a backend issue - the endpoint needs to populate address field') || 'This is a backend issue - the endpoint needs to populate address field' }}</p>
        </div>
      </div>

      <!-- Items to Collect -->
      <div class="modal-section" *ngIf="selectedOrderDetails()?.items">
        <div class="section-header">
          <div class="section-icon items-icon">
            <fa-icon [icon]="faCube" class="section-icon-svg"></fa-icon>
          </div>
          <h3 class="section-title">
            {{ translation.t('Items to Collect') || 'Items to Collect' }} ({{ selectedOrderDetails()?.items?.length || 0 }})
          </h3>
        </div>

        <div class="items-list">
          <div *ngFor="let item of selectedOrderDetails()?.items" class="item-card">
            <div class="item-image-container">
              <img
                *ngIf="item.image"
                [src]="item.image"
                [alt]="getItemName(item)"
                class="item-image"
                (error)="$event.target.style.display='none'; $event.target.nextElementSibling.style.display='flex'"
              />
              <div *ngIf="!item.image" class="item-image-placeholder">
                <fa-icon [icon]="faCube" class="item-placeholder-icon"></fa-icon>
              </div>
            </div>
            <div class="item-details">
              <h4 class="item-name">{{ getItemName(item) }}</h4>
              <div class="item-badges">
                <span class="item-badge quantity-badge">
                  <svg class="badge-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path>
                  </svg>
                  {{ translation.t('Qty') || 'Qty' }}: {{ item.quantity }}
                </span>
                <span class="item-badge unit-badge">
                  <svg class="badge-svg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16l3-1m-3 1-3-1"></path>
                  </svg>
                  {{ item.measurement_unit === 1 ? (translation.t('KG') || 'KG') : (translation.t('Piece') || 'Piece') }}
                </span>
                <span class="item-badge points-badge">
                ⭐ {{ item.points ? (item.points * item.quantity) : 0 }} {{ translation.t('pts') || 'pts' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="!selectedOrderDetails()?.items || selectedOrderDetails()?.items?.length === 0" class="no-data-card">
          <fa-icon [icon]="faCube" class="no-data-icon"></fa-icon>
          <p class="no-data-text">{{ translation.t('No items found in this order') || 'No items found in this order' }}</p>
        </div>

        <!-- Total Points Display -->
        <div *ngIf="selectedOrderDetails()?.items && selectedOrderDetails()?.items?.length > 0" class="total-points-card">
          <div class="total-points-content">
            <div class="total-points-info">
              <div class="points-icon-box">
                <svg class="points-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                </svg>
              </div>
              <div>
                <h4 class="points-title">{{ translation.t('Total Order Points') || 'Total Order Points' }}</h4>
                <p class="points-subtitle">{{ translation.t('Points will be added to customer account when order is completed') || 'Points will be added to customer account when order is completed' }}</p>
              </div>
            </div>
            <div class="total-points-value">
              <div class="points-number">⭐ {{ getOrderTotalPoints(selectedOrderDetails()!) }}</div>
              <div class="points-label">{{ translation.t('Points') || 'Points' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Complete Order Modal -->
<div *ngIf="showCompleteModal()" class="modal-overlay" (click)="closeCompleteModal()">
  <div class="modal-container complete-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-header-content">
        <h3 class="modal-title">{{ translation.t('Complete Delivery') || 'Complete Delivery' }}</h3>
      </div>
      <button (click)="closeCompleteModal()" class="modal-close">
        <fa-icon [icon]="faX" class="close-icon"></fa-icon>
      </button>
    </div>

    <div class="modal-body">
      <div class="order-info-section">
        <h4 class="order-info-title">
          {{ translation.t('Order Number') || 'Order Number' }}: {{ selectedOrder()?._id?.slice(-8) }}
        </h4>
        <p class="order-info-text">
          {{ translation.t('Customer') || 'Customer' }}: {{ selectedOrder()?.user?.userName || selectedOrder()?.user?.name }}
        </p>
      </div>

      <!-- Quantity Review Form for Customer Orders -->
      <div *ngIf="userRole() === 'customer' && showQuantityForm()" class="quantity-form-section">
        <div class="form-section-header">
          <fa-icon [icon]="faEdit" class="form-header-icon"></fa-icon>
          <h4 class="form-section-title">{{ translation.t('Verify Quantities') || 'Verify Quantities' }}</h4>
        </div>

        <div class="quantity-items-grid">
          <ng-container *ngFor="let item of quantities() | keyvalue">
            <div class="quantity-item-card">
              <div class="quantity-item-header">
                <span class="quantity-item-name">{{ item.value.name }}</span>
                <span class="quantity-item-unit">({{ item.value.unit }})</span>
              </div>

              <div class="quantity-inputs-grid">
                <div class="quantity-input-group">
                  <label class="quantity-label">{{ translation.t('Original') || 'Original' }}</label>
                  <input
                    type="number"
                    [value]="item.value.originalQuantity"
                    disabled
                    class="quantity-input disabled"
                  />
                </div>
                <div class="quantity-input-group">
                  <label class="quantity-label">{{ translation.t('Actual') || 'Actual' }} *</label>
                  <input
                    type="number"
                    [value]="item.value.actualQuantity"
                    (input)="handleQuantityChange(item.key, $any($event.target).value, item.value.measurement_unit)"
                    class="quantity-input"
                    [step]="item.value.measurement_unit === 2 ? '1' : '0.1'"
                    min="0"
                  />
                </div>
              </div>

              <div class="quantity-points-display">
                <div class="points-display-item original">
                  <span class="points-label">{{ translation.t('Original Points') || 'Original Points' }}:</span>
                  <span class="points-value">⭐ {{ translation.convertNumber(item.value.originalPoints) }}</span>
                </div>
                <div class="points-display-item current">
                  <span class="points-label">{{ translation.t('Current Points') || 'Current Points' }}:</span>
                  <span class="points-value">⭐ {{ translation.convertNumber(item.value.currentPoints) }}</span>
                </div>
              </div>

              <div *ngIf="item.value.originalQuantity !== item.value.actualQuantity && item.value.actualQuantity !== ''" class="quantity-difference">
                <span class="difference-text">
                      {{ translation.t('Difference') || 'Difference' }}: {{ calculateDifference(item.value.originalQuantity, item.value.actualQuantity, item.value.measurement_unit) }} {{ item.value.unit }}
                </span>
              </div>
            </div>
          </ng-container>
        </div>

        <div class="total-points-summary">
          <div class="summary-content">
            <span class="summary-label">{{ translation.t('Total Points') || 'Total Points' }}:</span>
            <div class="summary-values">
              <div class="summary-value-group">
                <div class="summary-value-label">{{ translation.t('Original') || 'Original' }}:</div>
                <div class="summary-value original">⭐ {{ getOriginalTotalPoints() }}</div>
              </div>
              <div class="summary-value-group">
                <div class="summary-value-label">{{ translation.t('Actual') || 'Actual' }}:</div>
                <div class="summary-value current">⭐ {{ getTotalPointsFromQuantities() }}</div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="hasQuantityChanges()" class="quantity-notes-section">
          <label class="notes-label">{{ translation.t('Reason for Changes') || 'Reason for Changes' }} *</label>
          <textarea
            [value]="quantityNotes()"
            (input)="quantityNotes.set($any($event.target).value)"
            [placeholder]="translation.t('Explain quantity differences...') || 'Explain quantity differences...'"
            class="notes-textarea"
            rows="2"
            required
          ></textarea>
        </div>
      </div>

      <!-- Estimated Weight Section -->
      <div *ngIf="userRole() === 'customer'" class="weight-section">
        <label class="weight-label">{{ translation.t('Estimated Weight (kg)') || 'Est. Weight (kg)' }} *:</label>
        <input
          type="number"
          [value]="notes()"
          (input)="notes.set($any($event.target).value)"
          [placeholder]="translation.t('Weight Placeholder') || 'e.g. 2.5'"
          class="weight-input"
          step="0.1"
          min="0"
          required
        />
      </div>

      <!-- General Notes for Non-Customer Orders -->
      <div *ngIf="userRole() !== 'customer'" class="notes-section">
        <label class="notes-label">{{ translation.t('Estimated Weight (kg)') || 'Est. Weight (kg)' }}:</label>
        <textarea
          [value]="notes()"
          (input)="notes.set($any($event.target).value)"
          [placeholder]="translation.t('Order Weight') || 'Order weight'"
          class="notes-textarea"
          rows="3"
        ></textarea>
      </div>

      <!-- Photo Upload Section -->
      <div class="photo-section">
        <label class="photo-label">{{ translation.t('Delivery Proof Photo') || 'Delivery Proof Photo' }} *</label>
        <div class="photo-upload-area">
          <div *ngIf="photoPreview(); else noPhoto" class="photo-preview-container">
            <img [src]="photoPreview()" alt="Delivery Proof" class="photo-preview">
            <button
              (click)="proofPhoto = null; photoPreview.set(''); fileInputRef.nativeElement.value = ''"
              class="photo-remove"
            >
              <fa-icon [icon]="faX" class="remove-icon"></fa-icon>
            </button>
          </div>
          <ng-template #noPhoto>
            <div class="photo-upload-placeholder">
              <fa-icon [icon]="faCamera" class="upload-icon"></fa-icon>
              <p class="upload-text">
                {{ translation.t('Take a photo of the order', { action: userRole() === 'customer' ? (translation.t('Collected') || 'collected') : (translation.t('Delivered') || 'delivered') }) || 'Take a photo of the order' }}
              </p>
              <button
                (click)="fileInputRef.nativeElement.click()"
                class="upload-button"
              >
                <fa-icon [icon]="faUpload" class="upload-button-icon"></fa-icon>
                    {{ translation.t('Upload Photo') || 'Upload Photo' }}
              </button>
            </div>
          </ng-template>
          <input
            #fileInput
            type="file"
            accept="image/*"
            capture="environment"
            (change)="handlePhotoSelect($event)"
            class="file-input"
          />
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="modal-actions">
        <button
          (click)="closeCompleteModal()"
          [disabled]="completing()"
          class="action-button cancel-button"
        >
          {{ translation.t('Cancel') || 'Cancel' }}
        </button>
        <button
          (click)="completeOrderWithProof()"
          [disabled]="!photoPreview() || completing() || (userRole() === 'customer' && !notes().trim())"
          class="action-button complete-button"
        >
          <div *ngIf="completing()" class="button-spinner"></div>
          <fa-icon *ngIf="!completing()" [icon]="faCheckCircle" class="button-icon"></fa-icon>
            {{ completing() ? (translation.t('Completing...') || 'Completing...') : (userRole() === 'customer' ? (translation.t('Mark as collected') || 'Mark as collected') : (translation.t('Mark as delivered') || 'Mark as delivered')) }}
        </button>
      </div>
    </div>
  </div>
</div>
